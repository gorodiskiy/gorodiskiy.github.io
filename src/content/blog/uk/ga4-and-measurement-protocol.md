---
title: "Наскрізна аналітика: Як ми інтегрували GA4 та Measurement Protocol"
description: "Технічний кейс про те, як не втрачати дані про конверсії за допомогою гібридного підходу: фронтенд-трекінг + серверні події."
pubDate: 2026-01-21
author: "Engineering Team"
category: "Analytics"
heroImage: "/images/Google-Analyics-4-Banner.jpg"
---

Нещодавно перед нами постало завдання: налаштувати надійну систему трекінгу платежів на нашому сайті. Ми вже реалізовували подібну логіку на іншому нашому проєкті, тому вирішили адаптувати перевірену схему, щоб отримати максимально точні дані про конверсії.

Головна проблема стандартного трекінгу через браузер — це **«сліпі зони»**. Користувач може ініціювати оплату, але не повернутися на сайт після завершення транзакції. Щоб не втрачати ці дані, ми впровадили гібридну систему.

---

### 1. Універсальний механізм відстеження

Ми почали зі створення функції-обгортки `trackEvent`. Вона дозволяє стандартизувати відправку подій та збагачувати їх необхідними метаданими «на льоту».

Наприклад, при ініціації депозиту ми генеруємо унікальний `event_id` та передаємо дані користувача з Intercom:

```javascript
trackEvent?.('deposit_started', {
    event_id: 'evt_' + Date.now(),
    currency: 'USD',
    value: data.get('quantity'),
    user_data: {
        email: intercomSiteUserEmail ?? '',
    },
});
```

### 2. Збереження контексту через Storage
Коли користувач переходить до оплати, ми не знаємо напевно, чи повернеться він на нашу сторінку підтвердження. Тому перед редиректом на платіжний шлюз ми зберігаємо об'єкт замовлення в `sessionStorage`

```javascript
let purchase_started_obj = {
    event_id: globalGA4Object.event_id,
    user_id: intercomSiteUserId ?? '',
    value: totalSum,
    currency: 'USD',
    items: items,
    user_data: {
        email: formData.get('email') ?? '',
    },
};

sessionStorage.setItem('pending_purchase', JSON.stringify(purchase_started_obj));
trackEvent?.('purchase_started', purchase_started_obj);
```

### 3. Обробка фіналу: сторінка "Thank You"
Якщо покупець успішно завершив оплату і повернувся на сторінку /thank/, ми дістаємо дані зі сховища та «збагачуємо» їх маркетинговими ідентифікаторами для точної атрибуції в рекламних кабінетах:

```javascript
const storedDataRaw = sessionStorage.getItem('pending_purchase');

if (storedDataRaw) {
    const storedData = JSON.parse(storedDataRaw);
    const enrichedObject = {
        ...storedData,
        transaction_id: '',
        gclid: globalGA4Object?.['gclid'] || '', // забираємо gclid для Google Ads
        fbp: getCookie('_fbp') || '',           // забираємо Facebook Pixel ID
        fbc: getCookie('_fbc') || ''            // забираємо Facebook Click ID
    };

    trackEvent?.('purchase_completed', enrichedObject);
    sessionStorage.removeItem('pending_purchase'); // очищуємо сесію
}
```
Порада: У випадку, якщо оплата була відхилена, ми аналогічно відправляємо івент purchase_failed. Це допомагає зрозуміти, на якому етапі виникають технічні чи фінансові труднощі у користувачів.

### 3. Measurement Protocol — наш «страховий поліс»
Найважливіша частина нашої інтеграції — використання GA4 Measurement Protocol.

Оскільки ми не маємо 100% гарантії, що клієнт дочекається завантаження сторінки подяки, ми підключили бекенд. Коли платіжна система надсилає нам callback про успішну транзакцію, наш сервер паралельно відправляє подію прямо в Google Analytics.

Ключовий момент: Щоб дані не дублювалися і коректно «склеювалися» в один шлях користувача, event_id на фронтенді та бекенді мають повністю збігатися. Це дозволяє системі аналітики зрозуміти, що подія з браузера та подія з сервера — це одна й та сама транзакція.

Підсумок
Такий підхід дозволив нам отримати:

✅ Повну статистику: ми бачимо 100% успішних оплат завдяки серверному трекінгу.

✅ Аналіз відмов: ми відстежуємо, на якому етапі виникають помилки.

✅ Точну атрибуцію: завдяки передачі gclid та fbp/fbc, ми точно знаємо, з якого рекламного каналу прийшов клієнт.

Ця схема вже вкотре доводить свою надійність, забезпечуючи нас чистими даними для прийняття рішень та розвитку нашого сайту.