---
title: "Сквозная аналитика: Как мы интегрировали GA4 и Measurement Protocol"
description: "Технический кейс о том, как не терять данные о конверсиях с помощью гибридного подхода: фронтенд-трекинг + серверные события."
pubDate: 2026-01-21
author: "Engineering Team"
category: "Analytics"
heroImage: "/images/Google-Analyics-4-Banner.jpg"
---

Недавно перед нами встала задача: настроить надежную систему трекинга платежей на нашем сайте. Мы уже реализовывали подобную логику на другом нашем проекте, поэтому решили адаптировать проверенную схему, чтобы получить максимально точные данные о конверсиях.

Главная проблема стандартного трекинга через браузер — это **«слепые зоны»**. Пользователь может инициировать оплату, но не вернуться на сайт после завершения транзакции. Чтобы не терять эти данные, мы внедрили гибридную систему.

---

### 1. Универсальный механизм отслеживания

Мы начали с создания функции-обертки `trackEvent`. Она позволяет стандартизировать отправку событий и обогащать их необходимыми метаданными «на лету».

Например, при инициации депозита мы генерируем уникальный `event_id` и передаем данные пользователя из Intercom:

```javascript
trackEvent?.('deposit_started', {
    event_id: 'evt_' + Date.now(),
    currency: 'USD',
    value: data.get('quantity'),
    user_data: {
        email: intercomSiteUserEmail ?? '',
    },
});
```
### 2.Сохранение контекста через Storage
Когда пользователь переходит к оплате, мы не знаем наверняка, вернется ли он на нашу страницу подтверждения. Поэтому перед редиректом на платежный шлюз мы сохраняем объект заказа в `sessionStorage`.

```javascript
let purchase_started_obj = {
    event_id: globalGA4Object.event_id,
    user_id: intercomSiteUserId ?? '',
    value: totalSum,
    currency: 'USD',
    items: items,
    user_data: {
        email: formData.get('email') ?? '',
    },
};

sessionStorage.setItem('pending_purchase', JSON.stringify(purchase_started_obj));
trackEvent?.('purchase_started', purchase_started_obj);
```

### 3.Обработка финала: страница "Thank You"
Если покупатель успешно завершил оплату и вернулся на страницу /thank/, мы достаем данные из хранилища и «обогащаем» их маркетинговыми идентификаторами для точной атрибуции в рекламных кабинетах:

```javascript
const storedDataRaw = sessionStorage.getItem('pending_purchase');

if (storedDataRaw) {
    const storedData = JSON.parse(storedDataRaw);
    const enrichedObject = {
        ...storedData,
        transaction_id: '',
        gclid: globalGA4Object?.['gclid'] || '', // забираем gclid для Google Ads
        fbp: getCookie('_fbp') || '',           // забираем Facebook Pixel ID
        fbc: getCookie('_fbc') || ''            // забираем Facebook Click ID
    };

    trackEvent?.('purchase_completed', enrichedObject);
    sessionStorage.removeItem('pending_purchase'); // очищаем сессию
}
```

Совет: В случае, если оплата была отклонена, мы аналогично отправляем ивент purchase_failed. Это помогает понять, на каком этапе возникают технические или финансовые трудности у пользователей.

### 4. Measurement Protocol — наш «страховой полис»
Самая важная часть нашей интеграции — использование GA4 Measurement Protocol.

Поскольку у нас нет 100% гарантии, что клиент дождется загрузки страницы благодарности, мы подключили бэкенд. Когда платежная система присылает нам callback об успешной транзакции, наш сервер параллельно отправляет событие напрямую в Google Analytics.

Ключевой момент: Чтобы данные не дублировались и корректно «склеивались» в один путь пользователя, event_id на фронтенде и бэкенде должны полностью совпадать. Это позволяет системе аналитики понять, что событие из браузера и событие с сервера — это одна и та же транзакция.

Итог
Такой подход позволил нам получить:

✅ Полную статистику: мы видим 100% успешных оплат благодаря серверному трекингу.

✅ Анализ отказов: мы отслеживаем, на каком этапе возникают ошибки.

✅ Точную атрибуцию: благодаря передаче gclid и fbp/fbc, мы точно знаем, из какого рекламного канала пришел клиент.

Эта схема уже в очередной раз доказывает свою надежность, обеспечивая нас чистыми данными для принятия решений и развития нашего сайта.